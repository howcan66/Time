<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Project - Enhanced Kanban Board</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            overflow: hidden;
            height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 60px;
        }

        .header-left { display: flex; align-items: center; gap: 12px; }
        .project-title { font-size: 24px; font-weight: bold; color: #667eea; }
        .title-short { display: none; }
        .title-full { display: inline; }
        .timestamp { font-size: 14px; color: #666; padding: 4px 10px; background: #f0f0f0; border-radius: 5px; }
        .project-controls { display: flex; align-items: center; gap: 6px; }
        .project-select { padding: 5px 8px; font-size: 12px; border: 1px solid #ddd; border-radius: 5px; background: white; height: 36px; box-sizing: border-box; }
        .project-btn {
            padding: 5px 8px; background: #10b981; color: white; border: none;
            border-radius: 5px; cursor: pointer; font-size: 12px; transition: background 0.3s;
            height: 36px; display: inline-flex; align-items: center; justify-content: center; box-sizing: border-box;
        }
        .project-btn:hover { background: #0e9f6e; }
        .project-btn.small { padding: 4px 6px; font-size: 11px; }
        .nav-buttons { display: flex; gap: 6px; }
        .nav-btn {
            padding: 5px 12px; background: #667eea; color: white; border: none;
            border-radius: 5px; cursor: pointer; font-size: 14px; transition: background 0.3s;
            height: 36px; display: inline-flex; align-items: center; justify-content: center; box-sizing: border-box;
        }
        .nav-btn:hover { background: #5568d3; }
        
        /* HJ-ID1RS11: Show/hide button text based on screen size */
        .btn-icon { display: none; }
        .btn-text { display: inline; }
        
        @media (max-width: 1024px) {
            .nav-btn .btn-text { display: none; }
            .nav-btn .btn-icon { display: inline; }
        }

        .mobile-toolbar {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            padding: 6px 10px;
            display: none;
            gap: 6px;
            align-items: center;
            z-index: 999;
        }
        .mobile-toolbar select {
            flex: 1;
            padding: 6px 8px;
            font-size: 13px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #fff;
            height: 32px;
        }
        .mobile-btn {
            padding: 6px 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 13px;
            cursor: pointer;
            height: 32px;
        }
        .mobile-btn.secondary { background: #10b981; }
        .mobile-btn.ghost { background: #6b7280; }

        .back-to-top {
            position: fixed;
            right: 16px;
            bottom: 18px;
            background: #667eea;
            color: #fff;
            border: none;
            border-radius: 999px;
            padding: 10px 12px;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1001;
        }
        .back-to-top.show { display: inline-flex; align-items: center; gap: 6px; }

        .kanban-container {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
            padding: 12px;
            height: calc(100vh - 60px);
            margin-top: 60px;
            overflow-x: scroll;
            overflow-y: hidden;
            scroll-snap-type: x proximity;
            touch-action: pan-x;
            -webkit-overflow-scrolling: touch;
        }

        .kanban-column {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            min-width: 240px;
            overflow: hidden;
            scroll-snap-align: start;
        }

        .column-header {
            padding: 12px;
            font-weight: bold;
            font-size: 14px;
            text-align: center;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .idea .column-header { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .todo .column-header { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .planning .column-header { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .design .column-header { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .test .column-header { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); }
        .done .column-header { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        .cancelled .column-header { background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%); }

        .add-task-btn {
            margin: 10px;
            padding: 8px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        .add-task-btn:hover { background: #5568d3; }

        @media (max-width: 800px) {
            .header { height: 55px; padding: 8px 10px; }
            .header-left { gap: 8px; }
            .project-title { font-size: 14px; }
            .title-full { display: none; }
            .title-short { display: inline; }
            .timestamp { display: none !important; }
            .project-controls { gap: 4px; }
            .project-select { font-size: 11px; padding: 4px 6px; height: 32px; }
            .project-btn { font-size: 10px; padding: 4px 6px; height: 32px; }
            .nav-btn { font-size: 10px; padding: 4px 8px; height: 32px; }
            
            /* HJ-ID1RS11: Mobile - icons only with tooltips */
            .project-btn:not(.admin-btn)::before { content: attr(title); display: none; }
            .nav-btn { min-width: auto; padding: 8px; }
            .nav-btn::after { content: none; }

            .mobile-toolbar { display: flex; }

            .kanban-container {
                margin-top: 105px;
                height: calc(100vh - 105px);
                display: flex;
                flex-wrap: nowrap;
                grid-template-columns: none;
                overflow-x: scroll;
                gap: 3px;
                -webkit-overflow-scrolling: touch;
                padding: 6px;
                box-sizing: border-box;
            }

            .kanban-column { 
                display: flex; 
                flex-direction: column; 
                height: 100%; 
                min-width: auto;
                overflow: visible;
                flex: 1;
                min-height: 0;
            }
            .column-header { font-size: 11px; padding: 6px; }
            .add-task-btn { display: none !important; } /* Hide - use mobile toolbar ‚ûï instead */
            .project-filter { margin: 0 6px 6px; display: flex; gap: 4px; flex-wrap: wrap; }
            .project-filter select { flex: 1; min-width: 100%; }
            .project-filter .project-btn { display: none; } /* Hide small ‚ûï - use mobile toolbar */
            .column-content { -webkit-overflow-scrolling: touch; flex: 1; overflow-y: auto; padding: 6px; }
            .task-card { cursor: default; padding: 4px; margin-bottom: 4px; }
            .task-row1 { font-size: 9px; margin-bottom: 3px; }
            .task-row2 { font-size: 11px; margin-bottom: 3px; }
            .project-tag { font-size: 8px; padding: 1px 3px; }
            .move-select { font-size: 10px; padding: 3px 5px; }
            .delete-btn, .icon-btn, .priority-btn { min-height: 30px; min-width: 30px; }
        }

        @media (max-width: 1024px) and (min-width: 801px) {
            /* HJ-ID1RS11: Feature 9 - Tablet - hide timestamp, show short title, streamline gaps */
            .header { height: 58px; padding: 9px 15px; }
            .header-left { gap: 10px; }
            .project-controls { gap: 5px; }
            .nav-buttons { gap: 5px; }
            .timestamp { display: none !important; }
            .title-full { display: none; }
            .title-short { display: inline; }
            
            .kanban-container {
                display: flex;
                flex-wrap: nowrap;
                grid-template-columns: none;
                overflow-x: scroll;
                -webkit-overflow-scrolling: touch;
                gap: 3px;
                padding: 8px;
            }
            .kanban-column { min-width: 240px; }
            .column-header { font-size: 12px; padding: 8px; }
            .add-task-btn { padding: 6px; font-size: 12px; }
            .task-card { padding: 6px; margin-bottom: 6px; }
            .task-row1 { font-size: 10px; margin-bottom: 4px; }
            .task-row2 { font-size: 12px; margin-bottom: 4px; }
            .project-tag { font-size: 9px; padding: 1px 4px; }
            .icon-btn { opacity: 1; font-size: 16px; padding: 4px; }
            .action-buttons { gap: 4px; }
            .move-select { font-size: 11px; padding: 4px 6px; }
        }

        .project-filter { display: flex; gap: 6px; margin: 0 10px 10px; }
        .project-filter select { flex: 1; padding: 4px 6px; font-size: 11px; border: 1px solid #ddd; border-radius: 3px; background: white; }

        .column-content { flex: 1; padding: 10px; overflow-y: auto; overflow-x: hidden; }
        .column-content::-webkit-scrollbar { width: 6px; }
        .column-content::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }

        .task-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            cursor: move;
            transition: all 0.2s;
        }
        .task-card:hover { transform: translateY(-1px); box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1); }
        .task-card[data-creator="HJ"] { border-left: 3px solid gold; }
        .task-card.dragging { opacity: 0.5; }
        .column-content.drag-over { background: rgba(102, 126, 234, 0.1); }

        .compact-mode .task-card { padding: 6px; margin-bottom: 6px; }
        .compact-mode .task-row1 { font-size: 10px; margin-bottom: 4px; }
        .compact-mode .task-row2 { font-size: 12px; margin-bottom: 4px; }
        .compact-mode .task-row3 { gap: 4px; }

        .task-row1 { display: flex; align-items: center; gap: 5px; margin-bottom: 5px; font-size: 11px; }
        .task-id { color: #888; font-weight: bold; flex-shrink: 0; line-height: 1.1; }
        .task-id-line { display: block; }
        .project-tag { font-size: 10px; color: #555; background: #f3f4f6; padding: 2px 6px; border-radius: 10px; }
        .priority-btn { width: 20px; height: 20px; border-radius: 50%; border: none; cursor: pointer; }
        .priority-1 { background: #22c55e; }
        .priority-2 { background: #3b82f6; }
        .priority-3 { background: #eab308; }
        .status-icon { font-size: 14px; cursor: pointer; }
        .action-buttons { margin-left: auto; display: flex; gap: 3px; }
        .icon-btn { background: none; border: none; cursor: pointer; font-size: 14px; padding: 2px; opacity: 0.7; }
        .icon-btn:hover { opacity: 1; }

        .task-row2 { font-size: 13px; font-weight: 500; color: #333; margin-bottom: 5px; cursor: pointer; line-height: 1.3; }
        .task-row2:hover { color: #667eea; }

        .task-row3 { display: flex; gap: 5px; align-items: center; }
        .move-select { flex: 1; padding: 3px 5px; font-size: 11px; border: 1px solid #ddd; border-radius: 3px; }
        .delete-btn { padding: 3px 8px; background: #ef4444; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 10px; }
        .delete-btn:hover { background: #dc2626; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        .modal-header { font-size: 20px; font-weight: bold; margin-bottom: 20px; color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 5px; color: #555; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px; }
        .form-group textarea { resize: vertical; min-height: 60px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .btn-primary { flex: 1; padding: 10px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .btn-primary:hover { background: #5568d3; }
        .btn-secondary { flex: 1; padding: 10px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .btn-secondary:hover { background: #4b5563; }
        
        /* LOGIN MODAL (HJ-ID1RS5) */
        .login-box { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); text-align: center; width: 90%; max-width: 350px; }
        .login-box h2 { margin-bottom: 20px; color: #667eea; font-size: 24px; }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; box-sizing: border-box; }
        .login-box input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 5px rgba(102, 126, 234, 0.3); }
        .login-box .login-error { color: #dc2626; font-size: 12px; margin: 10px 0; display: none; }
        .login-box .login-status { color: #059669; font-size: 12px; margin: 10px 0; }
        .login-btn { width: 100%; padding: 14px 16px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 600; margin-top: 15px; touch-action: manipulation; -webkit-appearance: none; box-sizing: border-box; }
        .password-wrapper { position: relative; display: flex; align-items: center; }
        .password-wrapper input { flex: 1; padding-right: 40px; }
        .toggle-password-btn { position: absolute; right: 10px; background: none; border: none; cursor: pointer; font-size: 16px; padding: 5px; color: #667eea; }
        .login-btn:hover { background: #5568d3; }
        .login-btn:active { background: #4a54b8; }
        .login-btn:disabled { background: #ccc; cursor: not-allowed; }
        
        @media (max-width: 600px) {
            .login-box { padding: 30px 20px; margin: 20px; }
            .login-box input { font-size: 16px; padding: 14px; }
            .login-btn { padding: 16px 20px; font-size: 16px; }
        }

        /* ADMIN PANEL (HJ-ID1RS7) */
        .admin-modal .modal-content { max-width: 900px; max-height: 90vh; }
        .admin-tabs { display: flex; gap: 5px; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .admin-tab { padding: 10px 20px; background: #f3f4f6; border: none; border-radius: 5px 5px 0 0; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; }
        .admin-tab.active { background: #667eea; color: white; }
        .admin-tab:hover:not(.active) { background: #e5e7eb; }
        .admin-tab-content { display: none; }
        .admin-tab-content.active { display: block; }
        .user-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 15px; }
        .user-table th { background: #f3f4f6; padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #ddd; }
        .user-table td { padding: 10px; border-bottom: 1px solid #e5e7eb; }
        .user-table tr:hover { background: #f9fafb; }
        .user-table .user-active { color: #10b981; font-weight: bold; }
        .user-table .user-inactive { color: #ef4444; font-weight: bold; }
        .user-actions { display: flex; gap: 5px; }
        .user-actions button { padding: 4px 8px; font-size: 11px; border: none; border-radius: 3px; cursor: pointer; }
        .btn-edit { background: #3b82f6; color: white; }
        .btn-edit:hover { background: #2563eb; }
        .btn-delete { background: #ef4444; color: white; }
        .btn-delete:hover { background: #dc2626; }
        .btn-reset { background: #f59e0b; color: white; }
        .btn-reset:hover { background: #d97706; }
        .role-checkboxes { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 5px; }
        .role-checkboxes label { display: flex; align-items: center; gap: 5px; font-size: 12px; }
        .log-viewer { max-height: 400px; overflow-y: auto; background: #f9fafb; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 12px; }
        .log-entry { padding: 5px 0; border-bottom: 1px solid #e5e7eb; }
        .log-entry:last-child { border-bottom: none; }
        .session-list { max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <!-- LOGIN MODAL (HJ-ID1RS5) -->
    <div id="loginModal" class="modal active">
        <div class="login-box">
            <h2>üîê Time Project Login</h2>
            <input type="text" id="loginUsername" placeholder="Username" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" onkeypress="if(event.key==='Enter') verifyLogin()">
            <div class="password-wrapper">
                <input type="password" id="loginPassword" placeholder="Password" autocomplete="off" autocorrect="off" spellcheck="false" onkeypress="if(event.key==='Enter') verifyLogin()">
                <button type="button" class="toggle-password-btn" onclick="togglePasswordVisibility(event)" title="Show/Hide Password">üëÅÔ∏è</button>
            </div>
            <div class="login-error" id="loginError"></div>
            <div class="login-status" id="loginStatus"></div>
            <button class="login-btn" id="loginBtn" type="button" onclick="verifyLogin()">Login</button>
            <button class="login-btn" style="background: #6b7280; margin-top: 8px;" type="button" onclick="toggleDemoMode()" title="For testing only">Demo Mode</button>
            <button class="login-btn" style="background: #9333ea; margin-top: 8px; font-size: 12px; padding: 10px;" type="button" onclick="resetLoginLockout()" title="Clear lockout">üîì Reset Lockout</button>
        </div>
    </div>

    <!-- ADMIN PANEL MODAL (HJ-ID1RS7) -->
    <div id="adminModal" class="modal admin-modal">
        <div class="modal-content">
            <div class="modal-header">‚öôÔ∏è Admin Dashboard</div>
            
            <div class="admin-tabs">
                <button class="admin-tab active" onclick="switchAdminTab('users')">üë• Users</button>
                <button class="admin-tab" onclick="switchAdminTab('logs')">üìã Login Logs</button>
                <button class="admin-tab" onclick="switchAdminTab('sessions')">üîí Sessions</button>
                <button class="admin-tab" onclick="switchAdminTab('invitations')">‚úâÔ∏è Invitations</button>
            </div>

            <!-- USERS TAB -->
            <div id="adminTab-users" class="admin-tab-content active">
                <button class="btn-primary" style="width: auto; margin-bottom: 15px;" onclick="openAddUserForm()">‚ûï Add New User</button>
                <div id="userTableContainer"></div>
            </div>

            <!-- LOGS TAB -->
            <div id="adminTab-logs" class="admin-tab-content">
                <div class="form-row" style="margin-bottom: 15px;">
                    <input type="text" id="logFilterUser" placeholder="Filter by username..." oninput="filterLogs()">
                    <select id="logFilterType" onchange="filterLogs()">
                        <option value="">All Types</option>
                        <option value="SUCCESS">Success</option>
                        <option value="FAILED">Failed</option>
                        <option value="LOCKED">Locked</option>
                    </select>
                </div>
                <div id="logViewer" class="log-viewer"></div>
            </div>

            <!-- SESSIONS TAB -->
            <div id="adminTab-sessions" class="admin-tab-content">
                <h3 style="margin-bottom: 10px; font-size: 14px;">Active Sessions</h3>
                <div id="sessionList" class="session-list"></div>
            </div>

            <!-- INVITATIONS TAB (HJ-ID1RS10) -->
            <div id="adminTab-invitations" class="admin-tab-content">
                <button class="btn-primary" style="width: auto; margin-bottom: 15px;" onclick="openInvitationForm()">‚úâÔ∏è Send Invitation</button>
                <div id="invitationTableContainer"></div>
            </div>

            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeAdminPanel()">Close</button>
            </div>
        </div>
    </div>

    <!-- USER FORM MODAL (HJ-ID1RS7) -->
    <div id="userFormModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="userFormTitle">Add New User</div>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="userFormUsername" placeholder="Enter username">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="userFormPassword" placeholder="Enter password">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="userFormEmail" placeholder="user@time.local">
            </div>
            <div class="form-group">
                <label>Roles (select multiple)</label>
                <div class="role-checkboxes">
                    <label><input type="checkbox" value="Project Manager"> Project Manager</label>
                    <label><input type="checkbox" value="Developer"> Developer</label>
                    <label><input type="checkbox" value="Reviewer"> Reviewer</label>
                    <label><input type="checkbox" value="Designer"> Designer</label>
                    <label><input type="checkbox" value="Tester"> Tester</label>
                    <label><input type="checkbox" value="Admin"> Admin</label>
                </div>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="userFormActive" checked> Active
                </label>
            </div>
            <div class="modal-buttons">
                <button class="btn-primary" onclick="saveUser()">Save User</button>
                <button class="btn-secondary" onclick="closeUserForm()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- INVITATION FORM MODAL (HJ-ID1RS10) -->
    <div id="invitationFormModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">‚úâÔ∏è Send Invitation</div>
            <div class="form-group">
                <label>Recipient Email</label>
                <input type="email" id="inviteEmail" placeholder="user@example.com">
            </div>
            <div class="form-group">
                <label>Custom Message (optional)</label>
                <textarea id="inviteMessage" placeholder="Add a personal message..." style="min-height: 60px;"></textarea>
            </div>
            <div class="form-group">
                <label>Expiration Days</label>
                <input type="number" id="inviteExpireDays" value="7" min="1" max="30">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="inviteForcePasswordChange" checked> Require password change on first login
                </label>
            </div>
            <div class="form-group">
                <label>Pre-assign Roles (optional)</label>
                <div class="role-checkboxes">
                    <label><input type="checkbox" value="Developer"> Developer</label>
                    <label><input type="checkbox" value="Reviewer"> Reviewer</label>
                    <label><input type="checkbox" value="Designer"> Designer</label>
                    <label><input type="checkbox" value="Tester"> Tester</label>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn-primary" onclick="generateInvitation()">Generate & Send</button>
                <button class="btn-secondary" onclick="closeInvitationForm()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="header">
        <div class="header-left">
            <div class="project-title"><span class="title-full">‚è∞ Time Project - Kanban Board</span><span class="title-short">‚è∞ Time Kanban</span></div>
            <div class="timestamp" id="timestamp">Loading...</div>
            <div class="project-controls">
                <select id="projectFilter" class="project-select" onchange="setGlobalProjectFilter(this.value)"></select>
                <button class="project-btn" onclick="createProjectFlow()">‚ûï Project</button>
            </div>
        </div>
        <div class="nav-buttons">
            <button class="nav-btn" id="adminBtn" onclick="openAdminPanel()" style="display: none;">‚öôÔ∏è Admin</button>
            <button class="nav-btn" onclick="exportAll()" title="Export all tasks to clipboard"><span class="btn-text">üìã Export All</span><span class="btn-icon">üìã</span></button>
            <button class="nav-btn" onclick="refreshTimestamp()" title="Refresh timestamp"><span class="btn-text">üîÑ Refresh</span><span class="btn-icon">üîÑ</span></button>
        </div>
    </div>

    <div class="mobile-toolbar">
        <select id="mobileProjectFilter" onchange="setGlobalProjectFilter(this.value)"></select>
        <select id="mobileColumnSelect" onchange="scrollToColumn(this.value)">
            <option value="">Jump to column...</option>
            <option value="1">1 - Idea</option>
            <option value="2">2 - Todo</option>
            <option value="3">3 - Planning</option>
            <option value="4">4 - Design</option>
            <option value="5">5 - Test</option>
            <option value="6">6 - Done</option>
            <option value="7">7 - Cancelled</option>
        </select>
        <button class="mobile-btn" onclick="openAddModal(currentColumn || 1)" title="Add new task">‚ûï</button>
        <button class="mobile-btn ghost" onclick="toggleCompactMode()" title="Toggle compact mode">üß©</button>
        <button class="mobile-btn secondary" onclick="exportAll()" title="Export tasks">üìã</button>
    </div>

    <button id="backToTop" class="back-to-top" onclick="scrollToTop()">‚¨ÜÔ∏è Top</button>

    <div class="kanban-container">
        <div class="kanban-column idea" data-column="1">
            <div class="column-header">1 - üí° Idea</div>
            <button class="add-task-btn" onclick="openAddModal(1)">‚ûï Add Task</button>
            <div class="project-filter">
                <select id="project-filter-1" onchange="setColumnProjectFilter(1, this.value)"></select>
                <button class="project-btn small" onclick="createProjectFlow()">‚ûï</button>
            </div>
            <div class="column-content" id="column-1"></div>
        </div>
        <div class="kanban-column todo" data-column="2">
            <div class="column-header">2 - üìã Todo</div>
            <button class="add-task-btn" onclick="openAddModal(2)">‚ûï Add Task</button>
            <div class="project-filter">
                <select id="project-filter-2" onchange="setColumnProjectFilter(2, this.value)"></select>
                <button class="project-btn small" onclick="createProjectFlow()">‚ûï</button>
            </div>
            <div class="column-content" id="column-2"></div>
        </div>
        <div class="kanban-column planning" data-column="3">
            <div class="column-header">3 - üìä Planning</div>
            <button class="add-task-btn" onclick="openAddModal(3)">‚ûï Add Task</button>
            <div class="project-filter">
                <select id="project-filter-3" onchange="setColumnProjectFilter(3, this.value)"></select>
                <button class="project-btn small" onclick="createProjectFlow()">‚ûï</button>
            </div>
            <div class="column-content" id="column-3"></div>
        </div>
        <div class="kanban-column design" data-column="4">
            <div class="column-header">4 - üé® Design</div>
            <button class="add-task-btn" onclick="openAddModal(4)">‚ûï Add Task</button>
            <div class="project-filter">
                <select id="project-filter-4" onchange="setColumnProjectFilter(4, this.value)"></select>
                <button class="project-btn small" onclick="createProjectFlow()">‚ûï</button>
            </div>
            <div class="column-content" id="column-4"></div>
        </div>
        <div class="kanban-column test" data-column="5">
            <div class="column-header">5 - üß™ Test</div>
            <button class="add-task-btn" onclick="openAddModal(5)">‚ûï Add Task</button>
            <div class="project-filter">
                <select id="project-filter-5" onchange="setColumnProjectFilter(5, this.value)"></select>
                <button class="project-btn small" onclick="createProjectFlow()">‚ûï</button>
            </div>
            <div class="column-content" id="column-5"></div>
        </div>
        <div class="kanban-column done" data-column="6">
            <div class="column-header">6 - ‚úÖ Done</div>
            <button class="add-task-btn" onclick="openAddModal(6)">‚ûï Add Task</button>
            <div class="project-filter">
                <select id="project-filter-6" onchange="setColumnProjectFilter(6, this.value)"></select>
                <button class="project-btn small" onclick="createProjectFlow()">‚ûï</button>
            </div>
            <div class="column-content" id="column-6"></div>
        </div>
        <div class="kanban-column cancelled" data-column="7">
            <div class="column-header">7 - ‚ùå Cancelled</div>
            <button class="add-task-btn" onclick="openAddModal(7)">‚ûï Add Task</button>
            <div class="project-filter">
                <select id="project-filter-7" onchange="setColumnProjectFilter(7, this.value)"></select>
                <button class="project-btn small" onclick="createProjectFlow()">‚ûï</button>
            </div>
            <div class="column-content" id="column-7"></div>
        </div>
    </div>

    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">Add New Task</div>
            <form id="taskForm">
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label>Task ID *</label>
                        <input type="text" id="taskId" placeholder="Auto-generated or enter manually" required>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" onclick="generateTaskId()" style="height: 36px; width: 100%; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">üîÑ Generate</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>What (Task Title) * - Detailed Description</label>
                    <textarea id="taskWhat" placeholder="Describe the task in detail..." required rows="6" style="min-height: 120px;"></textarea>
                </div>
                <div class="form-group">
                    <label>Why (Reason/Purpose)</label>
                    <textarea id="taskWhy" placeholder="Why is this needed?"></textarea>
                </div>
                <div class="form-group">
                    <label>How (Approach/Method)</label>
                    <textarea id="taskHow" placeholder="How will you approach this?"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Who</label>
                        <input type="text" id="taskWho" value="HJ">
                    </div>
                    <div class="form-group">
                        <label>When</label>
                        <input type="date" id="taskWhen">
                    </div>
                </div>
                <div class="form-group">
                    <label>Where</label>
                    <input type="text" id="taskWhere" placeholder="Location/file...">
                </div>
                <div class="form-group">
                    <label>Project</label>
                    <select id="taskProject"></select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Priority</label>
                        <select id="taskPriority">
                            <option value="1">1 - High (Green)</option>
                            <option value="2" selected>2 - Medium (Blue)</option>
                            <option value="3">3 - Low (Yellow)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="taskStatus">
                            <option value="Not Started">‚¨ú Not Started</option>
                            <option value="Executing">‚öôÔ∏è Executing</option>
                            <option value="Progressing">‚è≥ Progressing</option>
                            <option value="Done">‚úÖ Done</option>
                        </select>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn-primary">üíæ Save</button>
                    <button type="button" class="btn-secondary" onclick="closeModal()">‚ùå Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="viewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Task Details</div>
            <div id="viewContent"></div>
            <div class="modal-buttons">
                <button class="btn-primary" onclick="closeViewModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        const defaultTasks = [
            // OLD HJ ID TASKS (COMPLETED)
            { id: 'HJ-ID1', what: 'Kanban HTML Web Page', why: 'Visual project management system', how: 'Built with HTML/CSS/Vanilla JS', who: 'HJ', when: '2026-01-28', where: 'kanban.html', priority: 1, status: 'Done', column: 6, projectId: 'proj-1' },
            { id: 'HJ-ID2', what: 'Enhanced Kanban Forms', why: 'Interactive task management with modals', how: 'Modal forms + priority + status system', who: 'HJ', when: '2026-01-29', where: 'kanban.html', priority: 1, status: 'Done', column: 6, projectId: 'proj-1' },
            // NEW AI TD TASKS (PROJECT SETUP - proj-1)
            { id: 'AI-TD11', what: 'Create GitHub Repository', why: 'Set up version control and hosting', how: 'Configure GitHub repo + GitHub Pages', who: 'Team Lead', when: 'Week 1', where: 'github.com', priority: 1, status: 'Not Started', column: 1, projectId: 'proj-1' },
            { id: 'AI-TD12', what: 'Project Directory Structure', why: 'Organize project files logically', how: 'Create folders: css/, js/, assets/', who: 'Team Lead', when: 'Week 1', where: 'Local + GitHub', priority: 1, status: 'Not Started', column: 2, projectId: 'proj-1' },
            { id: 'AI-TD13', what: 'Base HTML Template', why: 'Create main entry point structure', how: 'Write index.html with meta tags, nav framework', who: 'Frontend Dev', when: 'Week 1', where: 'index.html', priority: 1, status: 'Not Started', column: 3, projectId: 'proj-1' },
            { id: 'AI-TD14', what: 'Global CSS Stylesheet', why: 'Define consistent styling across site', how: 'Create main.css with variables, resets, responsive', who: 'Frontend Dev', when: 'Week 1', where: 'css/main.css', priority: 2, status: 'Not Started', column: 3, projectId: 'proj-1' },
            // NEW AI TD TASKS (FEATURES - proj-2)
            { id: 'AI-TD15', what: 'Interactive Calendar', why: 'Display calendar with event marking', how: 'Build widget with month/year nav, grid, events', who: 'Frontend Dev', when: 'Week 2', where: 'features/calendar.js', priority: 1, status: 'Not Started', column: 1, projectId: 'proj-2' },
            { id: 'AI-TD16', what: 'Doomsday Clock Display', why: 'Show current Doomsday Clock status', how: 'Create display with countdown + info links', who: 'Frontend Dev', when: 'Week 2', where: 'features/doomsday.js', priority: 1, status: 'Not Started', column: 1, projectId: 'proj-2' },
            // NEW HJ-ID1RS# TASKS (KANBAN ENHANCEMENTS - proj-1)
            { id: 'HJ-ID1RS2', what: 'Enhanced Interactive Kanban', why: 'Rich task management UX', how: 'Priority/status toggle + modal edit + move/delete', who: 'AI', when: '2026-01-29', where: 'kanban.html', priority: 1, status: 'Done', column: 6, projectId: 'proj-1' },
            { id: 'HJ-ID1RS3', what: 'Device Detection Testing', why: 'Verify responsive design on all screen sizes', how: 'Test on desktop/tablet/mobile, verify drag-drop and menus', who: 'AI', when: 'Phase 2', where: 'kanban.html', priority: 2, status: 'Not Started', column: 3, projectId: 'proj-1' },
            { id: 'HJ-ID1RS4', what: 'Multi-Project Kanban', why: 'Organize work across multiple projects', how: 'Add project filters + dropdown selectors + sorting', who: 'AI', when: 'Phase 2', where: 'kanban.html', priority: 2, status: 'Not Started', column: 3, projectId: 'proj-1' },
            { id: 'HJ-ID1RS6', what: 'User/Role Assignment System', why: 'Assign tasks to users with multiple roles', how: 'Add assignee field + role checkboxes to task modal', who: 'AI', when: 'Phase 1', where: 'kanban.html', priority: 1, status: 'Not Started', column: 4, projectId: 'proj-1' },
            { id: 'HJ-ID1RS7', what: 'Admin User Management Panel', why: 'Manage users, roles, emails via admin dashboard', how: 'Create admin modal with user CRUD + email fields', who: 'AI', when: 'Phase 1', where: 'kanban.html', priority: 1, status: 'Done', column: 6, projectId: 'proj-1' },
            { id: 'HJ-ID1RS8', what: 'Print Kanban Board', why: 'Export board/columns as PDF for meetings', how: 'Add print buttons + @media print CSS (LS/PT)', who: 'AI', when: 'Phase 1', where: 'kanban.html', priority: 1, status: 'Not Started', column: 4, projectId: 'proj-1' },
            { id: 'HJ-ID1RS9', what: 'Email Column Group', why: 'Send column tasks to team via email', how: 'Email modal + mailto link + Copy fallback', who: 'AI', when: 'Phase 1', where: 'kanban.html', priority: 1, status: 'Not Started', column: 4, projectId: 'proj-1' },
            { id: 'HJ-ID1RS9-Logging', what: 'Email Event Logging', why: 'Track ASSIGN + MOVED events for audit trail', how: 'Log to Email_Log.txt on assignment/movement', who: 'AI', when: 'Phase 1', where: 'Email_Log.txt', priority: 1, status: 'Not Started', column: 4, projectId: 'proj-1' },
            { id: 'HJ-ID1RS9-P2', what: 'Email Notifications (Phase 2)', why: 'Auto-send emails on task assign/move', how: 'Notification triggers + FormSubmit or backend', who: 'TBD', when: 'Phase 2 (L8R)', where: 'kanban.html', priority: 2, status: 'Deferred', column: 7, projectId: 'proj-1' },
            { id: 'HJ-ID1RS10', what: 'Admin User Invitations System', why: 'Send invite links with credentials to new team members', how: 'Invitations tab in admin + mailto + clipboard fallback', who: 'AI', when: 'Phase 1', where: 'kanban.html', priority: 1, status: 'Done', column: 6, projectId: 'proj-1' },

            // RESERVED HJ-ID (placeholder)
            { id: 'HJ-ID1RS11', what: 'Responsive Font Sizing for Mobile/Tablet', why: 'Improve readability and fit content on different screen sizes', how: '1) For Tablet: reduce font to fit screen resolution; For Mobile phone: reduce font size more than tablet. 2) For Tablet and mobile: remove timestamp. 3) For Export: take away "All" text for tablet and mobile; for refresh have only refresh icon. On mobile: have only icons with mouseover showing the button names. 4) Tablet and Mobile: Page name change from "Time Project - Kanban Board" to "Time Kanban". 5) The Project, Logout (Admin), Export buttons shall all have the same vertical size. 6) Task form: Add Generate ID button, manual edit textform for ID, and detailed "what" description field with 6 rows. 7) Feature 8: Add task form navigation row (Min/Max toggle, Export, Print, Mail, Notification, Project dropdown). 8) Feature 9: Streamline all application gaps on row above and below text and buttons in top row for desktop, tablet and mobile - standardize padding/margins: header 60px desktop/58px tablet/55px mobile, reduce gaps between elements, mobile toolbar 32px button height, overall compact appearance. 9) Feature 10: Reduce all column gaps to 3px for desktop/tablet/mobile for best fit - tighter column spacing throughout app', who: 'AI', when: 'TBD', where: 'kanban.html CSS @media queries + add modal', priority: 2, status: 'In Progress', column: 4, projectId: 'proj-1' },

            // LOGIN & SECURITY COMPLETIONS (proj-1)
            { id: 'HJ-ID1RS5', what: 'Password Protection & Login', why: 'Secure access to board', how: 'Login modal + per-user lockout', who: 'AI', when: '2026-01-29', where: 'kanban.html', priority: 1, status: 'Done', column: 6, projectId: 'proj-1' },
            { id: 'NEW-LOGIN-PWD', what: 'Password Visibility Toggle', why: 'Reduce login errors', how: 'Eye icon + toggle input type', who: 'AI', when: '2026-01-29', where: 'kanban.html', priority: 1, status: 'Done', column: 6, projectId: 'proj-1' },
            { id: 'NEW-LOGIN-ATTEMPTS', what: 'Lockout Threshold (5 Strikes)', why: 'Balance security and UX', how: 'Increase lockout to 5 attempts', who: 'AI', when: '2026-01-29', where: 'kanban.html', priority: 1, status: 'Done', column: 6, projectId: 'proj-1' },
            { id: 'TPK-v1-BUG-01-001', what: 'Login Lockout Reset Bug', why: 'User stuck after correct login', how: 'Reset locked flag + lockUntil', who: 'AI', when: '2026-01-29', where: 'kanban.html', priority: 1, status: 'Done', column: 6, projectId: 'proj-1' },
            { id: 'TPK-v1-FIX-01-001', what: 'Reset Lockout Flags on Login', why: 'Ensure successful login clears lockout', how: 'Clear attempts/lockUntil/disabled state', who: 'AI', when: '2026-01-29', where: 'kanban.html', priority: 1, status: 'Done', column: 6, projectId: 'proj-1' },

            // RESPONSIVE FEATURES (AF3/AF4) - planned
            { id: 'TPK-v1-RES-02-005', what: 'Minimized View Selection at Login (AF3)', why: 'Compact UI for small screens', how: 'Login selector + localStorage viewMode', who: 'AI', when: 'Phase 2', where: 'kanban.html', priority: 2, status: 'Not Started', column: 3, projectId: 'proj-1' },
            { id: 'TPK-v1-RES-02-006', what: 'Header Minimization Toggle (AF4)', why: 'Maximize board space', how: 'Header toggle + CSS minimized state', who: 'AI', when: 'Phase 2', where: 'kanban.html', priority: 2, status: 'Not Started', column: 3, projectId: 'proj-1' },
            { id: 'TPK-v1-RES-02-007', what: 'Mobile Header & Toolbar Optimization', why: 'Improve mobile navigation and actions', how: 'Compact header + mobile toolbar + quick actions', who: 'AI', when: 'Phase 2', where: 'kanban.html', priority: 2, status: 'Not Started', column: 3, projectId: 'proj-1' },

            // EPIC OVERVIEW (high-level)
            { id: 'TPK-EPIC-SEC-01', what: 'EPIC: Security & Access', why: 'Secure login and lockout controls', how: 'HJ-ID1RS5 + NEW-LOGIN + BUG/FIX', who: 'AI', when: 'Phase 1', where: 'kanban.html', priority: 2, status: 'Done', column: 6, projectId: 'proj-1' },
            { id: 'TPK-EPIC-ADM-01', what: 'EPIC: Admin & Invitations', why: 'User management + onboarding', how: 'HJ-ID1RS7 + HJ-ID1RS10', who: 'AI', when: 'Phase 1', where: 'kanban.html', priority: 2, status: 'Done', column: 6, projectId: 'proj-1' },
            { id: 'TPK-EPIC-RES-02', what: 'EPIC: Responsive & Views', why: 'Adaptive UX across devices', how: 'HJ-ID1RS3 + AF3 + AF4', who: 'AI', when: 'Phase 2', where: 'kanban.html', priority: 2, status: 'Not Started', column: 3, projectId: 'proj-1' },
            { id: 'TPK-EPIC-EXP-02', what: 'EPIC: Print & Export', why: 'Share board externally', how: 'HJ-ID1RS8', who: 'AI', when: 'Phase 2', where: 'kanban.html', priority: 2, status: 'Not Started', column: 4, projectId: 'proj-1' },
            { id: 'TPK-EPIC-COM-02', what: 'EPIC: Communication', why: 'Email and notifications', how: 'HJ-ID1RS9 + RS9-Logging + RS9-P2', who: 'AI', when: 'Phase 2', where: 'kanban.html', priority: 2, status: 'Not Started', column: 4, projectId: 'proj-1' },
            { id: 'TPK-EPIC-ORG-02', what: 'EPIC: Organization', why: 'Multi-project structure', how: 'HJ-ID1RS4', who: 'AI', when: 'Phase 2', where: 'kanban.html', priority: 2, status: 'Not Started', column: 3, projectId: 'proj-1' },
            { id: 'TPK-EPIC-TSK-03', what: 'EPIC: Task Management', why: 'Assignments and ownership', how: 'HJ-ID1RS6', who: 'AI', when: 'Phase 2', where: 'kanban.html', priority: 3, status: 'Not Started', column: 4, projectId: 'proj-1' },
            { id: 'TPK-EPIC-DOC-02', what: 'EPIC: Documentation System', why: 'TPK-NIRS tracking & docs', how: 'TPK-NIRS proposal + master index', who: 'AI', when: 'Phase 1', where: 'TPK_NIRS_*', priority: 3, status: 'Done', column: 6, projectId: 'proj-1' },
        ];
        let tasks = defaultTasks.map(task => ({ ...task }));
        let taskIdCounter = 24;
        
        // PASSWORD PROTECTION (HJ-ID1RS5) - Valid Credentials (Updated 2026-01-29)
        // ENHANCED SCHEMA (HJ-ID1RS7) - email, roles array, active, lastLogin
        let validUsers = [
            { username: 'R18', password: 'R18', email: 'r18@time.local', roles: ['Project Manager'], active: true, lastLogin: null },
            { username: 'Maximus', password: 'Maximus', email: 'maximus@time.local', roles: ['Developer'], active: true, lastLogin: null },
            { username: 'Joel', password: 'Joel', email: 'joel@time.local', roles: ['Reviewer'], active: true, lastLogin: null },
            { username: 'admin', password: 'admin', email: 'admin@time.local', roles: ['Admin'], active: true, lastLogin: null }
        ];
        let currentUser = null;
        // PER-USER LOCKOUT TRACKING - Use localStorage so it resets on page reload
        let loginAttemptsByUser = {}; // { username: { attempts: 0, locked: false, lockUntil: null } }
        let currentColumn = 1;
        let editingTaskId = null;
        let deviceInfo = {};
        let draggedTaskId = null;
        let projects = [
            { id: 'proj-1', name: 'Time Project Kanban', priority: 1 },
            { id: 'proj-2', name: 'Time Website Features', priority: 2 }
        ];
        let globalProjectFilter = 'all';
        let columnProjectFilters = { 1: 'all', 2: 'all', 3: 'all', 4: 'all', 5: 'all', 6: 'all', 7: 'all' };

        // ===== PASSWORD PROTECTION (HJ-ID1RS5) =====
        function verifyLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const errorDiv = document.getElementById('loginError');
            const statusDiv = document.getElementById('loginStatus');
            const loginBtn = document.getElementById('loginBtn');
            
            console.log(`üì± Login attempt: username="${username}" (length=${username.length}), password="${password.length > 0 ? '***' : ''}" (length=${password.length})`);
            
            errorDiv.style.display = 'none';
            statusDiv.textContent = '';
            
            // Initialize user lockout tracking if not exists
            if (!loginAttemptsByUser[username]) {
                loginAttemptsByUser[username] = { attempts: 0, locked: false, lockUntil: null };
                console.log(`üîë New login attempt for user: ${username}`);
            }
            const userLockout = loginAttemptsByUser[username];
            console.log(`Login check for ${username}: attempts=${userLockout.attempts}, locked=${userLockout.locked}`);
            
            // Check if THIS USER is locked
            if (userLockout.locked && userLockout.lockUntil > Date.now()) {
                const minutesLeft = Math.ceil((userLockout.lockUntil - Date.now()) / 60000);
                errorDiv.textContent = `Account locked. Try again in ${minutesLeft} minute(s).`;
                errorDiv.style.display = 'block';
                loginBtn.disabled = true;
                console.log(`üîí User ${username} is locked out`);
                return;
            } else if (userLockout.locked && userLockout.lockUntil <= Date.now()) {
                // Lockout expired, reset for this user
                userLockout.locked = false;
                userLockout.attempts = 0;
                userLockout.lockUntil = null;
                loginBtn.disabled = false;
                console.log(`‚úì Lockout expired for ${username}, resetting`);
            }
            
            // Validate input
            if (!username || !password) {
                errorDiv.textContent = 'Username and password required.';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Check credentials
            const user = validUsers.find(u => u.username === username && u.password === password);
            if (user) {
                currentUser = user;
                userLockout.attempts = 0;
                userLockout.locked = false;
                userLockout.lockUntil = null;
                user.lastLogin = new Date().toISOString();
                loginBtn.disabled = false;
                // PERSIST SESSION TO LOCALSTORAGE
                localStorage.setItem('timeProjectSession', JSON.stringify({
                    username: user.username,
                    roles: user.roles,
                    email: user.email,
                    lastLogin: user.lastLogin
                }));
                logLoginAttempt(username, 'SUCCESS', 0);
                console.log(`‚úì Login SUCCESS for ${username}`);
                console.log(`‚úì currentUser set to:`, currentUser);
                document.getElementById('loginModal').classList.remove('active');
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                loadTasks();
                renderAllColumns();
                attachDragListeners();
                
                // Force header update
                setTimeout(() => {
                    updateHeader();
                    console.log(`‚úì Header updated with user: ${currentUser.username}`);
                }, 100);
                
                statusDiv.textContent = `Welcome, ${user.username}! (${user.roles ? user.roles.join(', ') : user.role || ''})`;
                statusDiv.style.color = '#059669';
            } else {
                userLockout.attempts++;
                logLoginAttempt(username, 'FAILED', userLockout.attempts);
                console.log(`‚ùå Login FAILED for ${username}: attempt ${userLockout.attempts}/5`);
                
                if (userLockout.attempts >= 5) {
                    userLockout.locked = true;
                    userLockout.lockUntil = Date.now() + (5 * 60 * 1000); // 5 min lockout
                    errorDiv.textContent = 'Too many failed attempts. Account locked for 5 minutes.';
                    loginBtn.disabled = true;
                    logLoginAttempt(username, 'LOCKED', userLockout.attempts);
                    console.log(`üîí User ${username} LOCKED for 5 minutes`);
                } else {
                    errorDiv.textContent = `Invalid credentials. Attempt ${userLockout.attempts}/5`;
                }
                errorDiv.style.display = 'block';
            }
        }

        function togglePasswordVisibility(evt) {
            const pwdInput = document.getElementById('loginPassword');
            const btn = evt ? evt.currentTarget : document.querySelector('.toggle-password-btn');
            if (!pwdInput || !btn) return;
            if (pwdInput.type === 'password') {
                pwdInput.type = 'text';
                btn.textContent = 'üò®'; // Closed eye = password now visible
                btn.title = 'Hide Password';
            } else {
                pwdInput.type = 'password';
                btn.textContent = 'üëÅÔ∏è'; // Open eye = password hidden
                btn.title = 'Show Password';
            }
        }

        function resetLoginLockout() {
            loginAttemptsByUser = {};
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            const pwdToggle = document.querySelector('.toggle-password-btn');
            if (pwdToggle) {
                pwdToggle.textContent = 'üëÅÔ∏è';
                pwdToggle.title = 'Show Password';
                document.getElementById('loginPassword').type = 'password';
            }
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('loginStatus').textContent = '‚úÖ Lockout cleared! Try again.';
            document.getElementById('loginStatus').style.color = '#059669';
            document.getElementById('loginBtn').disabled = false;
            console.log('‚úì All login lockouts cleared');
            setTimeout(() => {
                document.getElementById('loginStatus').textContent = '';
            }, 3000);
        }

        function logLoginAttempt(username, status, attemptNum) {
            const timestamp = new Date().toLocaleString();
            const logEntry = `[${timestamp}] | ${username} | ${status} | Attempt #${attemptNum}`;
            console.log('LOGIN LOG:', logEntry);
            // In future: Send to Login_Log.txt via backend
        }

        function toggleDemoMode() {
            // For testing: automatically log in as first user
            document.getElementById('loginUsername').value = 'R18';
            document.getElementById('loginPassword').value = 'R18';
            console.log('üì± Demo Mode activated - attempting login with R18/R18');
            verifyLogin();
        }

        function updateHeader() {
            if (currentUser) {
                const headerLeft = document.querySelector('.header-left');
                if (!document.getElementById('userDisplay')) {
                    const userDisplay = document.createElement('div');
                    userDisplay.id = 'userDisplay';
                    userDisplay.style.cssText = 'font-size: 12px; color: #059669; padding: 5px 10px; background: #ecfdf5; border-radius: 5px; display: flex; align-items: center; gap: 10px;';
                    const roles = currentUser.roles ? currentUser.roles.join(', ') : currentUser.role || '';
                    userDisplay.innerHTML = `üë§ ${currentUser.username} (${roles}) <button onclick="logout()" style="background: #dc2626; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">Logout</button>`;
                    headerLeft.appendChild(userDisplay);
                }
                
                // Show/hide admin button (HJ-ID1RS7)
                const adminBtn = document.getElementById('adminBtn');
                if (adminBtn) {
                    adminBtn.style.display = isAdmin() ? 'inline-block' : 'none';
                }
            }
        }

        function logout() {
            currentUser = null;
            // Clear session from localStorage
            localStorage.removeItem('timeProjectSession');
            // Don't reset other users' lockout status - only clear current session
            document.getElementById('loginModal').classList.add('active');
            const userDisplay = document.getElementById('userDisplay');
            if (userDisplay) userDisplay.remove();
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            logLoginAttempt('(unknown)', 'LOGOUT', 0);
        }

        // ===== END PASSWORD PROTECTION =====

        // ===== ADMIN PANEL (HJ-ID1RS7) =====
        let editingUserId = null;
        let adminLogs = [];

        function isAdmin() {
            if (!currentUser) return false;
            if (currentUser.roles) return currentUser.roles.includes('Admin');
            return currentUser.role === 'Admin';
        }

        function logAdminAction(action, details) {
            const timestamp = new Date().toLocaleString();
            const logEntry = `[${timestamp}] | ${currentUser.username} | ${action} | ${details}`;
            adminLogs.push(logEntry);
            console.log('ADMIN LOG:', logEntry);
            // In future: Send to Admin_Log.txt via backend
        }

        function openAdminPanel() {
            if (!isAdmin()) {
                alert('Access denied. Admin role required.');
                return;
            }
            document.getElementById('adminModal').classList.add('active');
            renderUserTable();
            renderLoginLogs();
            renderSessionList();
        }

        function closeAdminPanel() {
            document.getElementById('adminModal').classList.remove('active');
        }

        function switchAdminTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.remove('active'));
            
            // Show selected tab
            document.querySelector(`.admin-tab[onclick*="${tabName}"]`).classList.add('active');
            document.getElementById(`adminTab-${tabName}`).classList.add('active');
            
            // Refresh data
            if (tabName === 'users') renderUserTable();
            if (tabName === 'logs') renderLoginLogs();
            if (tabName === 'sessions') renderSessionList();
        }

        function renderUserTable() {
            const container = document.getElementById('userTableContainer');
            let html = '<table class="user-table"><thead><tr>';
            html += '<th>Username</th><th>Email</th><th>Roles</th><th>Last Login</th><th>Status</th><th>Actions</th>';
            html += '</tr></thead><tbody>';
            
            validUsers.forEach((user, idx) => {
                const roles = user.roles ? user.roles.join(', ') : user.role || '';
                const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleString() : 'Never';
                const statusClass = user.active ? 'user-active' : 'user-inactive';
                const statusText = user.active ? '‚úì Active' : '‚úó Inactive';
                
                html += `<tr>
                    <td><strong>${user.username}</strong></td>
                    <td>${user.email || 'N/A'}</td>
                    <td>${roles}</td>
                    <td>${lastLogin}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td class="user-actions">
                        <button class="btn-edit" onclick="openEditUserForm(${idx})">Edit</button>
                        <button class="btn-reset" onclick="resetPassword(${idx})">Reset</button>
                        <button class="btn-delete" onclick="deleteUser(${idx})">Delete</button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function openAddUserForm() {
            editingUserId = null;
            document.getElementById('userFormTitle').textContent = 'Add New User';
            document.getElementById('userFormUsername').value = '';
            document.getElementById('userFormPassword').value = '';
            document.getElementById('userFormEmail').value = '';
            document.getElementById('userFormActive').checked = true;
            document.querySelectorAll('.role-checkboxes input').forEach(cb => cb.checked = false);
            document.getElementById('userFormModal').classList.add('active');
        }

        function openEditUserForm(idx) {
            editingUserId = idx;
            const user = validUsers[idx];
            document.getElementById('userFormTitle').textContent = 'Edit User';
            document.getElementById('userFormUsername').value = user.username;
            document.getElementById('userFormPassword').value = user.password;
            document.getElementById('userFormEmail').value = user.email || '';
            document.getElementById('userFormActive').checked = user.active !== false;
            
            // Set role checkboxes
            document.querySelectorAll('.role-checkboxes input').forEach(cb => {
                if (user.roles) {
                    cb.checked = user.roles.includes(cb.value);
                } else {
                    cb.checked = user.role === cb.value;
                }
            });
            
            document.getElementById('userFormModal').classList.add('active');
        }

        function closeUserForm() {
            document.getElementById('userFormModal').classList.remove('active');
            editingUserId = null;
        }

        function saveUser() {
            const username = document.getElementById('userFormUsername').value.trim();
            const password = document.getElementById('userFormPassword').value.trim();
            const email = document.getElementById('userFormEmail').value.trim();
            const active = document.getElementById('userFormActive').checked;
            
            // Get selected roles
            const roles = [];
            document.querySelectorAll('.role-checkboxes input:checked').forEach(cb => {
                roles.push(cb.value);
            });
            
            if (!username || !password) {
                alert('Username and password are required.');
                return;
            }
            
            if (roles.length === 0) {
                alert('Please select at least one role.');
                return;
            }
            
            const userData = {
                username,
                password,
                email,
                roles,
                active,
                lastLogin: null
            };
            
            if (editingUserId !== null) {
                // Edit existing user
                const oldUsername = validUsers[editingUserId].username;
                validUsers[editingUserId] = userData;
                logAdminAction('EDIT_USER', `Updated user: ${oldUsername} ‚Üí ${username}`);
            } else {
                // Add new user
                if (validUsers.find(u => u.username === username)) {
                    alert('Username already exists.');
                    return;
                }
                validUsers.push(userData);
                logAdminAction('ADD_USER', `Added new user: ${username} (${roles.join(', ')})`);
            }
            
            closeUserForm();
            renderUserTable();
        }

        function deleteUser(idx) {
            const user = validUsers[idx];
            if (user.username === currentUser.username) {
                alert('Cannot delete your own account.');
                return;
            }
            if (confirm(`Delete user "${user.username}"? This action cannot be undone.`)) {
                validUsers.splice(idx, 1);
                logAdminAction('DELETE_USER', `Deleted user: ${user.username}`);
                renderUserTable();
            }
        }

        function resetPassword(idx) {
            const user = validUsers[idx];
            const newPassword = prompt(`Enter new password for "${user.username}":`);
            if (newPassword) {
                user.password = newPassword;
                logAdminAction('RESET_PASSWORD', `Reset password for: ${user.username}`);
                alert(`Password reset successfully for ${user.username}`);
            }
        }

        function renderLoginLogs() {
            const viewer = document.getElementById('logViewer');
            // Simulate login log entries (in future: read from Login_Log.txt)
            const sampleLogs = [
                '[2026-01-29 10:15:23] | R18 | SUCCESS | Attempt #1',
                '[2026-01-29 10:20:45] | admin | SUCCESS | Attempt #1',
                '[2026-01-29 10:25:12] | unknown | FAILED | Attempt #1',
                '[2026-01-29 10:26:34] | unknown | FAILED | Attempt #2',
                '[2026-01-29 10:27:56] | unknown | FAILED | Attempt #3',
                '[2026-01-29 10:28:10] | unknown | LOCKED | Attempt #3',
            ];
            
            let html = '';
            sampleLogs.forEach(log => {
                html += `<div class="log-entry">${log}</div>`;
            });
            viewer.innerHTML = html || '<div style="text-align: center; color: #888;">No logs available</div>';
        }

        function filterLogs() {
            // Placeholder for log filtering functionality
            renderLoginLogs();
        }

        function renderSessionList() {
            const container = document.getElementById('sessionList');
            // Simulate active sessions (in future: track real sessions)
            const sessions = [
                { username: currentUser.username, loginTime: new Date().toLocaleString(), ip: '127.0.0.1', device: 'Chrome Desktop' }
            ];
            
            let html = '<table class="user-table"><thead><tr>';
            html += '<th>Username</th><th>Login Time</th><th>IP Address</th><th>Device</th><th>Actions</th>';
            html += '</tr></thead><tbody>';
            
            sessions.forEach(session => {
                html += `<tr>
                    <td><strong>${session.username}</strong></td>
                    <td>${session.loginTime}</td>
                    <td>${session.ip}</td>
                    <td>${session.device}</td>
                    <td><button class="btn-delete" onclick="alert('Force logout not yet implemented')">Force Logout</button></td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // ===== INVITATIONS (HJ-ID1RS10) =====
        let clientInvitations = [];

        function generateRandomCredentials() {
            const username = 'user_' + new Date().getFullYear() + '_' + Math.random().toString(36).substr(2, 9).toUpperCase();
            const password = Math.random().toString(36).substr(2, 8) + Math.random().toString(36).substr(2, 2).toUpperCase();
            return { username, password };
        }

        function openInvitationForm() {
            document.getElementById('inviteEmail').value = '';
            document.getElementById('inviteMessage').value = '';
            document.getElementById('inviteExpireDays').value = '7';
            document.getElementById('inviteForcePasswordChange').checked = true;
            document.querySelectorAll('#invitationFormModal .role-checkboxes input').forEach(cb => cb.checked = false);
            document.getElementById('invitationFormModal').classList.add('active');
        }

        function closeInvitationForm() {
            document.getElementById('invitationFormModal').classList.remove('active');
        }

        function generateInvitation() {
            const email = document.getElementById('inviteEmail').value.trim();
            const message = document.getElementById('inviteMessage').value.trim();
            const expireDays = parseInt(document.getElementById('inviteExpireDays').value);
            const forcePasswordChange = document.getElementById('inviteForcePasswordChange').checked;
            
            if (!email || !email.includes('@')) {
                alert('Please enter a valid email address.');
                return;
            }

            // Check for duplicate pending invitations
            if (clientInvitations.find(inv => inv.email === email && inv.status === 'Sent')) {
                alert('Pending invitation already exists for this email.');
                return;
            }

            const credentials = generateRandomCredentials();
            const expirationDate = new Date();
            expirationDate.setDate(expirationDate.getDate() + expireDays);
            
            const invitation = {
                id: 'inv_' + Date.now(),
                email,
                tempUsername: credentials.username,
                tempPassword: credentials.password,
                message,
                datesent: new Date().toLocaleString(),
                expiresOn: expirationDate.toLocaleString(),
                expireDays,
                status: 'Sent',
                forcePasswordChange,
                roles: [],
                viewed: false,
                accepted: false
            };

            // Get selected roles
            document.querySelectorAll('#invitationFormModal .role-checkboxes input:checked').forEach(cb => {
                invitation.roles.push(cb.value);
            });

            clientInvitations.push(invitation);
            logAdminAction('SEND_INVITATION', `Sent invitation to: ${email} (expires in ${expireDays} days)`);
            
            // Generate email
            generateInvitationEmail(invitation);
            
            closeInvitationForm();
            renderInvitationTable();
            alert(`Invitation generated for ${email}. Click "Send via Email" to send.`);
        }

        function generateInvitationEmail(invitation) {
            const projectUrl = window.location.origin + window.location.pathname;
            const emailSubject = `You're Invited to Join Time Project Kanban`;
            const emailBody = `Hi there,

You've been invited to join the Time Project Kanban board!

PROJECT: Time Project - Enhanced Kanban Board
LOGIN URL: ${projectUrl}

TEMPORARY CREDENTIALS:
Username: ${invitation.tempUsername}
Password: ${invitation.tempPassword}

HOW TO ACCESS:
1. Visit: ${projectUrl}
2. Enter your temporary username and password
3. On first login, you'll be prompted to change your password
4. Start collaborating!

${invitation.message ? `\nMESSAGE FROM ADMIN:\n${invitation.message}\n` : ''}

IMPORTANT:
‚Ä¢ This invitation expires on: ${invitation.expiresOn}
‚Ä¢ Your temporary credentials are for initial access only
‚Ä¢ You MUST change your password on first login
‚Ä¢ Do not share these credentials via email

Questions? Contact your admin.

---
Time Project Kanban Board
${projectUrl}`;

            invitation.emailBody = emailBody;
            invitation.emailSubject = emailSubject;
        }

        function sendViaEmail(invitationId) {
            const invitation = clientInvitations.find(inv => inv.id === invitationId);
            if (!invitation) return;

            const mailtoLink = `mailto:${invitation.email}?subject=${encodeURIComponent(invitation.emailSubject)}&body=${encodeURIComponent(invitation.emailBody)}`;
            window.location.href = mailtoLink;
            logAdminAction('EMAIL_SENT', `Sent invitation email to: ${invitation.email}`);
        }

        function copyToClipboard(invitationId) {
            const invitation = clientInvitations.find(inv => inv.id === invitationId);
            if (!invitation) return;

            const textToCopy = `${invitation.emailSubject}\n\n${invitation.emailBody}`;
            navigator.clipboard.writeText(textToCopy).then(() => {
                alert('Invitation text copied to clipboard!');
                logAdminAction('INVITE_COPIED', `Invitation copied to clipboard for: ${invitation.email}`);
            }).catch(() => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = textToCopy;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('Invitation text copied to clipboard!');
            });
        }

        function revokeInvitation(invitationId) {
            const idx = clientInvitations.findIndex(inv => inv.id === invitationId);
            if (idx !== -1) {
                const email = clientInvitations[idx].email;
                clientInvitations[idx].status = 'Revoked';
                logAdminAction('REVOKE_INVITATION', `Revoked invitation for: ${email}`);
                renderInvitationTable();
            }
        }

        function renderInvitationTable() {
            const container = document.getElementById('invitationTableContainer');
            
            if (clientInvitations.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888;">No invitations sent yet.</p>';
                return;
            }

            let html = '<table class="user-table"><thead><tr>';
            html += '<th>Email</th><th>Temp Username</th><th>Status</th><th>Sent Date</th><th>Expires</th><th>Actions</th>';
            html += '</tr></thead><tbody>';
            
            clientInvitations.forEach(inv => {
                const statusColor = inv.status === 'Sent' ? '#3b82f6' : inv.status === 'Accepted' ? '#10b981' : '#ef4444';
                html += `<tr>
                    <td>${inv.email}</td>
                    <td><code style="font-family: monospace; font-size: 11px;">${inv.tempUsername}</code></td>
                    <td style="color: ${statusColor}; font-weight: bold;">${inv.status}</td>
                    <td>${inv.datesent}</td>
                    <td>${inv.expiresOn}</td>
                    <td class="user-actions">
                        ${inv.status === 'Sent' ? `
                            <button class="btn-edit" onclick="sendViaEmail('${inv.id}')" title="Send via mailto">‚úâÔ∏è Email</button>
                            <button class="btn-edit" onclick="copyToClipboard('${inv.id}')" title="Copy to clipboard">üìã Copy</button>
                            <button class="btn-delete" onclick="revokeInvitation('${inv.id}')">Revoke</button>
                        ` : inv.status === 'Revoked' ? `
                            <em style="color: #999;">Revoked</em>
                        ` : `
                            <em style="color: #999;">Completed</em>
                        `}
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        // ===== END INVITATIONS =====

        // Device Detection (Hybrid Method)
        function detectDevice() {
            const width = window.innerWidth;
            const supportsTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            const hasCoarsePointer = window.matchMedia('(pointer: coarse)').matches;
            
            deviceInfo = {
                isDesktop: width > 800 && !supportsTouch && !hasCoarsePointer,
                isTablet: width > 800 && (supportsTouch || hasCoarsePointer),
                isMobile: width <= 800,
                supportsTouch: supportsTouch,
                width: width
            };
            
            updateDragDropState();
        }

        function updateDragDropState() {
            const enableDrag = deviceInfo.isDesktop || deviceInfo.isTablet;
            document.querySelectorAll('.task-card').forEach(card => {
                card.setAttribute('draggable', enableDrag);
            });
        }

        function getProjectById(projectId) {
            return projects.find(p => p.id === projectId);
        }

        function getProjectName(projectId) {
            const project = getProjectById(projectId);
            return project ? project.name : 'Unassigned';
        }

        function getProjectPriority(projectId) {
            const project = getProjectById(projectId);
            return project ? project.priority : 99;
        }

        function getProjectOptions(includeAll) {
            const sorted = [...projects].sort((a, b) => a.priority - b.priority);
            const options = sorted.map(p => `<option value="${p.id}">${p.name} (P${p.priority})</option>`).join('');
            return (includeAll ? '<option value="all">All Projects</option>' : '') + options;
        }

        function renderProjectDropdowns() {
            const headerSelect = document.getElementById('projectFilter');
            if (headerSelect) {
                headerSelect.innerHTML = getProjectOptions(true);
                headerSelect.value = globalProjectFilter;
            }

            const mobileProjectSelect = document.getElementById('mobileProjectFilter');
            if (mobileProjectSelect) {
                mobileProjectSelect.innerHTML = getProjectOptions(true);
                mobileProjectSelect.value = globalProjectFilter;
            }

            for (let i = 1; i <= 7; i++) {
                const select = document.getElementById(`project-filter-${i}`);
                if (select) {
                    select.innerHTML = getProjectOptions(true);
                    select.value = columnProjectFilters[i] || 'all';
                }
            }

            const taskProjectSelect = document.getElementById('taskProject');
            if (taskProjectSelect) {
                taskProjectSelect.innerHTML = getProjectOptions(false);
            }
        }

        function setGlobalProjectFilter(projectId) {
            globalProjectFilter = projectId;
            renderAllColumns();
            const headerSelect = document.getElementById('projectFilter');
            if (headerSelect && headerSelect.value !== projectId) headerSelect.value = projectId;
            const mobileProjectSelect = document.getElementById('mobileProjectFilter');
            if (mobileProjectSelect && mobileProjectSelect.value !== projectId) mobileProjectSelect.value = projectId;
        }

        function setColumnProjectFilter(columnNum, projectId) {
            columnProjectFilters[columnNum] = projectId;
            renderColumn(columnNum);
        }

        function createProjectFlow() {
            const name = prompt('New project name?');
            if (!name) return;
            let priorityInput = prompt('Project priority (1=High, 2=Medium, 3=Low):', '2');
            let priority = parseInt(priorityInput, 10);
            if (![1, 2, 3].includes(priority)) priority = 2;
            const id = `proj-${Date.now()}`;
            projects.push({ id, name, priority });
            renderProjectDropdowns();
            renderAllColumns();
        }

        function initSampleTasks() {
            tasks = defaultTasks.map(task => ({ ...task }));
            taskIdCounter = 27;
            renderAllColumns();
        }

        function mergeMissingTasks() {
            const existingIds = new Set(tasks.map(t => t.id));
            const missing = defaultTasks.filter(t => !existingIds.has(t.id));
            if (missing.length) {
                tasks = tasks.concat(missing.map(task => ({ ...task })));
                saveTasks();
            }
        }

        function dedupeTasksById(taskList) {
            const seen = new Set();
            const deduped = [];
            taskList.forEach(task => {
                if (!task || !task.id) return;
                if (seen.has(task.id)) return;
                seen.add(task.id);
                deduped.push(task);
            });
            return deduped;
        }

        function generateTaskId() {
            const prefixes = ['AI-TD', 'TPK-v1', 'HJ-ID1RS', 'NEW', 'EPIC'];
            const randomPrefix = prefixes[Math.floor(Math.random() * prefixes.length)];
            const randomNum = Math.floor(Math.random() * 1000);
            const newId = `${randomPrefix}${randomNum}`;
            document.getElementById('taskId').value = newId;
        }

        function openAddModal(column) {
            currentColumn = column;
            editingTaskId = null;
            document.getElementById('modalTitle').textContent = 'Add New Task';
            document.getElementById('taskForm').reset();
            document.getElementById('taskWho').value = 'HJ';
            generateTaskId(); /* Auto-generate ID for new task */
            const taskProjectSelect = document.getElementById('taskProject');
            const columnFilter = columnProjectFilters[column] || 'all';
            const preferredProject = columnFilter !== 'all'
                ? columnFilter
                : (globalProjectFilter !== 'all' ? globalProjectFilter : projects[0].id);
            if (taskProjectSelect) taskProjectSelect.value = preferredProject;
            document.getElementById('taskModal').classList.add('active');
            const shouldFocus = (deviceInfo && (deviceInfo.isMobile || deviceInfo.isTablet)) || window.innerWidth <= 800;
            if (shouldFocus) {
                setTimeout(() => {
                    const taskWhat = document.getElementById('taskWhat');
                    if (taskWhat) taskWhat.focus();
                }, 50);
            }
        }

        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            editingTaskId = taskId;
            currentColumn = task.column;
            document.getElementById('modalTitle').textContent = 'Edit Task';
            document.getElementById('taskId').value = task.id; /* Show existing ID for editing */
            document.getElementById('taskWhat').value = task.what;
            document.getElementById('taskWhy').value = task.why || '';
            document.getElementById('taskHow').value = task.how || '';
            document.getElementById('taskWho').value = task.who || 'HJ';
            document.getElementById('taskWhen').value = task.when || '';
            document.getElementById('taskWhere').value = task.where || '';
            document.getElementById('taskPriority').value = task.priority;
            document.getElementById('taskStatus').value = task.status;
            document.getElementById('taskProject').value = task.projectId || projects[0].id;
            document.getElementById('taskModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('taskModal').classList.remove('active');
        }

        function viewTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            const content = `
                <div style="line-height:1.8;"><p><strong>ID:</strong> ${task.id}</p>
                <p><strong>Project:</strong> ${getProjectName(task.projectId)}</p>
                <p><strong>What:</strong> ${task.what}</p>
                <p><strong>Why:</strong> ${task.why || 'Not specified'}</p>
                <p><strong>How:</strong> ${task.how || 'Not specified'}</p>
                <p><strong>Who:</strong> ${task.who || 'HJ'}</p>
                <p><strong>When:</strong> ${task.when || 'Not specified'}</p>
                <p><strong>Where:</strong> ${task.where || 'Not specified'}</p>
                <p><strong>Priority:</strong> ${task.priority} - ${task.priority===1?'High':task.priority===2?'Medium':'Low'}</p>
                <p><strong>Status:</strong> ${task.status}</p></div>
            `;
            document.getElementById('viewContent').innerHTML = content;
            document.getElementById('viewModal').classList.add('active');
        }

        function closeViewModal() {
            document.getElementById('viewModal').classList.remove('active');
        }

        document.getElementById('taskForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const taskId = document.getElementById('taskId').value || `HJ TD${taskIdCounter++}`;
            const taskData = {
                id: editingTaskId || taskId,
                what: document.getElementById('taskWhat').value,
                why: document.getElementById('taskWhy').value,
                how: document.getElementById('taskHow').value,
                who: document.getElementById('taskWho').value,
                when: document.getElementById('taskWhen').value,
                where: document.getElementById('taskWhere').value,
                priority: parseInt(document.getElementById('taskPriority').value),
                status: document.getElementById('taskStatus').value,
                column: currentColumn,
                projectId: document.getElementById('taskProject').value
            };
            if (editingTaskId) {
                tasks[tasks.findIndex(t => t.id === editingTaskId)] = taskData;
            } else {
                tasks.push(taskData);
            }
            saveTasks();
            renderAllColumns();
            closeModal();
        });

        function togglePriority(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.priority = task.priority === 3 ? 1 : task.priority + 1;
                saveTasks();
                renderColumn(task.column);
            }
        }

        function toggleStatus(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                const statuses = ['Not Started', 'Executing', 'Progressing', 'Done'];
                task.status = statuses[(statuses.indexOf(task.status) + 1) % statuses.length];
                saveTasks();
                renderColumn(task.column);
            }
        }

        function moveTask(taskId, newColumn) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                const oldColumn = task.column;
                task.column = parseInt(newColumn);
                saveTasks();
                renderColumn(oldColumn);
                renderColumn(newColumn);
            }
        }

        function deleteTask(taskId) {
            if (confirm('Delete this task permanently?')) {
                const column = tasks.find(t => t.id === taskId).column;
                tasks = tasks.filter(t => t.id !== taskId);
                saveTasks();
                renderColumn(column);
            }
        }

        // ===== TASK PERSISTENCE TO LOCALSTORAGE =====
        function saveTasks() {
            localStorage.setItem('timeProjectTasks', JSON.stringify(tasks));
            console.log('‚úì Tasks saved to localStorage');
        }

        function loadTasks() {
            const saved = localStorage.getItem('timeProjectTasks');
            if (saved) {
                try {
                    tasks = JSON.parse(saved);
                    console.log('‚úì Tasks loaded from localStorage:', tasks.length);
                    const deduped = dedupeTasksById(tasks);
                    if (deduped.length !== tasks.length) {
                        tasks = deduped;
                        saveTasks();
                    }
                    mergeMissingTasks();
                    return true;
                } catch (e) {
                    console.log('Failed to load tasks:', e);
                    localStorage.removeItem('timeProjectTasks');
                    return false;
                }
            }
            return false;
        }

        function getStatusIcon(status) {
            return status === 'Not Started' ? '‚¨ú' : status === 'Executing' ? '‚öôÔ∏è' : status === 'Progressing' ? '‚è≥' : '‚úÖ';
        }

        // Drag and Drop Handlers
        function handleDragStart(e) {
            draggedTaskId = e.target.dataset.taskId;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.innerHTML);
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.column-content').forEach(col => {
                col.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            if (e.target.classList.contains('column-content')) {
                e.target.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            if (e.target.classList.contains('column-content')) {
                e.target.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();
            e.preventDefault();
            
            const targetColumn = e.target.closest('.kanban-column');
            if (targetColumn && draggedTaskId) {
                const newColumn = parseInt(targetColumn.dataset.column);
                const task = tasks.find(t => t.id === draggedTaskId);
                if (task && task.column !== newColumn) {
                    moveTask(draggedTaskId, newColumn);
                }
            }
            
            e.target.classList.remove('drag-over');
            draggedTaskId = null;
            return false;
        }

        function attachDragListeners() {
            document.querySelectorAll('.column-content').forEach(col => {
                col.addEventListener('dragover', handleDragOver);
                col.addEventListener('dragenter', handleDragEnter);
                col.addEventListener('dragleave', handleDragLeave);
                col.addEventListener('drop', handleDrop);
            });
        }

        function renderTaskCard(task) {
            const creator = task.id.startsWith('HJ') ? 'HJ' : 'AI';
            const projectName = getProjectName(task.projectId);
            const idParts = task.id.includes('-') ? task.id.split('-', 2) : [task.id, ''];
            const idDisplay = idParts[1]
                ? `<span class="task-id-line">${idParts[0]}-</span><span class="task-id-line">${task.id.substring(idParts[0].length + 1)}</span>`
                : `<span class="task-id-line">${task.id}</span>`;
            return `
                <div class="task-card" data-task-id="${task.id}" data-creator="${creator}" draggable="${deviceInfo.isDesktop || deviceInfo.isTablet}" ondragstart="handleDragStart(event)" ondragend="handleDragEnd(event)">
                    <div class="task-row1">
                        <span class="task-id">${idDisplay}</span>
                        <span class="project-tag">${projectName}</span>
                        <button class="priority-btn priority-${task.priority}" onclick="togglePriority('${task.id}')"></button>
                        <span class="status-icon" onclick="toggleStatus('${task.id}')">${getStatusIcon(task.status)}</span>
                        <div class="action-buttons">
                            <button class="icon-btn" onclick="viewTask('${task.id}')">üëÅÔ∏è</button>
                            <button class="icon-btn" onclick="editTask('${task.id}')">üìù</button>
                        </div>
                    </div>
                    <div class="task-row2" onclick="viewTask('${task.id}')">${task.what}</div>
                    <div class="task-row3">
                        <select class="move-select" onchange="moveTask('${task.id}', this.value)">
                            <option value="">Move to...</option>
                            ${[1,2,3,4,5,6,7].map(i => `<option value="${i}" ${task.column===i?'selected':''}>${i}-${['Idea','Todo','Plan','Design','Test','Done','Cancel'][i-1]}</option>`).join('')}
                        </select>
                        <button class="delete-btn" onclick="deleteTask('${task.id}')">üóëÔ∏è</button>
                    </div>
                </div>
            `;
        }

        function renderColumn(columnNum) {
            const columnFilter = columnProjectFilters[columnNum] || 'all';
            const activeFilter = columnFilter !== 'all' ? columnFilter : globalProjectFilter;
            const columnTasks = tasks
                .filter(t => t.column === columnNum)
                .filter(t => activeFilter === 'all' || t.projectId === activeFilter)
                .sort((a, b) => {
                    const projectDelta = getProjectPriority(a.projectId) - getProjectPriority(b.projectId);
                    if (projectDelta !== 0) return projectDelta;
                    return a.priority - b.priority;
                });
            const columnEl = document.getElementById(`column-${columnNum}`);
            columnEl.innerHTML = columnTasks.length === 0 ? '<div style="text-align:center;color:#999;padding:20px;font-size:12px;">No tasks</div>' : columnTasks.map(renderTaskCard).join('');
        }

        function renderAllColumns() {
            for (let i = 1; i <= 7; i++) renderColumn(i);
            updateDragDropState();
        }

        function exportAll() {
            let output = 'TIME PROJECT - KANBAN EXPORT\\n================================\\nDate: ' + new Date().toLocaleDateString() + '\\n\\n';
            const cols = ['Idea', 'Todo', 'Planning', 'Design', 'Test', 'Done', 'Cancelled'];
            for (let i = 1; i <= 7; i++) {
                const columnTasks = tasks.filter(t => t.column === i).sort((a, b) => a.priority - b.priority);
                output += `\\n${i}. ${cols[i-1].toUpperCase()}\\n` + '-'.repeat(50) + '\\n';
                if (columnTasks.length === 0) {
                    output += 'No tasks\\n';
                } else {
                    columnTasks.forEach(task => {
                        output += `${task.id} | ${task.what} | P:${task.priority} | ${task.status}\\n`;
                        if (task.why) output += `  Why: ${task.why}\\n`;
                        if (task.how) output += `  How: ${task.how}\\n`;
                        if (task.who) output += `  Who: ${task.who}\\n`;
                        if (task.when) output += `  When: ${task.when}\\n`;
                        if (task.where) output += `  Where: ${task.where}\\n`;
                        output += '\\n';
                    });
                }
            }
            navigator.clipboard.writeText(output).then(() => alert('‚úÖ Copied to clipboard!'));
        }

        function updateTimestamp() {
            const now = new Date();
            document.getElementById('timestamp').textContent = now.toLocaleString('en-US', { year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit' });
        }

        function refreshTimestamp() { updateTimestamp(); }

        function scrollToColumn(columnNum) {
            const parsed = parseInt(columnNum, 10);
            if (!parsed) return;
            currentColumn = parsed;
            const target = document.querySelector(`.kanban-column[data-column="${parsed}"]`);
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'start', inline: 'start' });
            }
        }

        function scrollToTop() {
            const container = document.querySelector('.kanban-container');
            if (container) container.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function toggleCompactMode() {
            const current = localStorage.getItem('compactMode') === 'true';
            const next = !current;
            localStorage.setItem('compactMode', String(next));
            document.body.classList.toggle('compact-mode', next);
        }

        function initMobileEnhancements() {
            const container = document.querySelector('.kanban-container');
            const backToTop = document.getElementById('backToTop');
            if (!container || !backToTop) return;

            const updateBackToTop = () => {
                if (container.scrollTop > 200) {
                    backToTop.classList.add('show');
                } else {
                    backToTop.classList.remove('show');
                }
            };

            container.addEventListener('scroll', updateBackToTop, { passive: true });
            updateBackToTop();

            const compactEnabled = localStorage.getItem('compactMode') === 'true';
            document.body.classList.toggle('compact-mode', compactEnabled);
        }
        
        // RESTORE SESSION FROM LOCALSTORAGE ON PAGE LOAD
        function restoreSession() {
            const savedSession = localStorage.getItem('timeProjectSession');
            if (savedSession) {
                try {
                    const session = JSON.parse(savedSession);
                    const user = validUsers.find(u => u.username === session.username);
                    if (user) {
                        currentUser = user;
                        document.getElementById('loginModal').classList.remove('active');
                        loadTasks();
                        renderAllColumns();
                        attachDragListeners();
                        
                        // Force header update with delay
                        setTimeout(() => {
                            updateHeader();
                            console.log('‚úì Session restored for:', session.username);
                        }, 100);
                        
                        return true;
                    } else {
                        console.log('User not found in validUsers, clearing corrupted session');
                        localStorage.removeItem('timeProjectSession');
                    }
                } catch (e) {
                    console.log('Session restore failed:', e);
                    localStorage.removeItem('timeProjectSession');
                }
            }
            return false;
        }
        
        // RESET LOCKOUT STATE AND CHECK FOR EXISTING SESSION
        function initializeLoginState() {
            // CLEAR ALL LOCKOUTS ON PAGE RELOAD - Fresh start for every user
            loginAttemptsByUser = {};
            console.log('‚úì Page loaded: All user lockouts cleared');
            
            // Try to restore session
            if (!restoreSession()) {
                // No session, show login modal
                document.getElementById('loginModal').classList.add('active');
            }
        }
        
        // Check for existing session before showing login
        document.addEventListener('DOMContentLoaded', initializeLoginState);
        document.addEventListener('DOMContentLoaded', initMobileEnhancements);
        
        // Initialize
        detectDevice();
        window.addEventListener('resize', () => {
            clearTimeout(window.resizeTimer);
            window.resizeTimer = setTimeout(detectDevice, 250);
        });
        updateTimestamp();
        setInterval(updateTimestamp, 1000);
        renderProjectDropdowns();
        // Don't render board until logged in (security)
        // renderAllColumns() and attachDragListeners() called in verifyLogin() after success
    </script>
</body>
</html>